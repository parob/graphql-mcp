<!DOCTYPE html>
<html>
<head>
    <title>MCP Browser Debug Test</title>
    <style>
        body { font-family: monospace; padding: 20px; background: #f0f0f0; }
        .test-result { margin: 10px 0; padding: 10px; border-radius: 5px; }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .info { background: #d1ecf1; color: #0c5460; }
        pre { background: #fff; padding: 10px; border-radius: 5px; overflow-x: auto; }
    </style>
</head>
<body>
    <h1>MCP Browser Request Debug</h1>
    <div id="results"></div>

    <script>
        const resultsDiv = document.getElementById('results');

        function addResult(type, message, data = null) {
            const div = document.createElement('div');
            div.className = `test-result ${type}`;
            div.innerHTML = `<strong>${message}</strong>`;
            if (data) {
                const pre = document.createElement('pre');
                pre.textContent = JSON.stringify(data, null, 2);
                div.appendChild(pre);
            }
            resultsDiv.appendChild(div);
        }

        async function debugMCPRequest() {
            const mcpUrl = 'http://localhost:8003/mcp';

            addResult('info', `Testing MCP endpoint: ${mcpUrl}`);

            // Test 1: Basic connectivity
            try {
                addResult('info', 'Test 1: Basic connectivity with GET request');
                const getResponse = await fetch(mcpUrl, { method: 'GET' });
                addResult('info', `GET response status: ${getResponse.status} ${getResponse.statusText}`);

                const getHeaders = {};
                for (const [key, value] of getResponse.headers.entries()) {
                    getHeaders[key] = value;
                }
                addResult('info', 'GET response headers:', getHeaders);
            } catch (error) {
                addResult('error', `GET request failed: ${error.message}`);
            }

            // Test 2: POST with minimal headers
            try {
                addResult('info', 'Test 2: POST with minimal headers');
                const minimalRequest = {
                    jsonrpc: '2.0',
                    id: 1,
                    method: 'tools/list',
                    params: {}
                };

                const minimalResponse = await fetch(mcpUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(minimalRequest)
                });

                addResult('info', `Minimal POST status: ${minimalResponse.status} ${minimalResponse.statusText}`);

                const minimalText = await minimalResponse.text();
                addResult('info', 'Minimal POST response:', {
                    body: minimalText.substring(0, 200) + (minimalText.length > 200 ? '...' : ''),
                    fullLength: minimalText.length
                });

            } catch (error) {
                addResult('error', `Minimal POST failed: ${error.message}`);
            }

            // Test 3: POST with Accept header
            try {
                addResult('info', 'Test 3: POST with Accept header');
                const acceptRequest = {
                    jsonrpc: '2.0',
                    id: 2,
                    method: 'tools/list',
                    params: {}
                };

                const acceptResponse = await fetch(mcpUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json, text/event-stream'
                    },
                    body: JSON.stringify(acceptRequest)
                });

                addResult('info', `Accept POST status: ${acceptResponse.status} ${acceptResponse.statusText}`);

                const acceptHeaders = {};
                for (const [key, value] of acceptResponse.headers.entries()) {
                    acceptHeaders[key] = value;
                }
                addResult('info', 'Accept POST response headers:', acceptHeaders);

                const acceptText = await acceptResponse.text();
                addResult(acceptResponse.ok ? 'success' : 'error',
                    `Accept POST response (${acceptResponse.ok ? 'SUCCESS' : 'FAILED'}):`, {
                    body: acceptText.substring(0, 300) + (acceptText.length > 300 ? '...' : ''),
                    fullLength: acceptText.length
                });

            } catch (error) {
                addResult('error', `Accept POST failed: ${error.message}`);
            }

            // Test 4: Different user agents
            try {
                addResult('info', 'Test 4: POST with custom user agent');
                const uaRequest = {
                    jsonrpc: '2.0',
                    id: 3,
                    method: 'tools/list',
                    params: {}
                };

                const uaResponse = await fetch(mcpUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json, text/event-stream',
                        'User-Agent': 'MCP-Web-Inspector/1.0'
                    },
                    body: JSON.stringify(uaRequest)
                });

                addResult('info', `User-Agent POST status: ${uaResponse.status} ${uaResponse.statusText}`);

            } catch (error) {
                addResult('error', `User-Agent POST failed: ${error.message}`);
            }

            // Test 5: Check for CORS issues
            try {
                addResult('info', 'Test 5: Checking CORS preflight');
                const corsResponse = await fetch(mcpUrl, {
                    method: 'OPTIONS'
                });

                addResult('info', `CORS OPTIONS status: ${corsResponse.status}`);

                const corsHeaders = {};
                for (const [key, value] of corsResponse.headers.entries()) {
                    corsHeaders[key] = value;
                }
                addResult('info', 'CORS headers:', corsHeaders);

            } catch (error) {
                addResult('error', `CORS check failed: ${error.message}`);
            }

            // Test 6: Inspect the exact request being sent
            addResult('info', 'Test 6: Request details');
            const testRequest = {
                jsonrpc: '2.0',
                id: 4,
                method: 'tools/list',
                params: {}
            };

            addResult('info', 'Request payload being sent:', testRequest);
            addResult('info', 'Request payload JSON:', { json: JSON.stringify(testRequest) });
            addResult('info', 'Current page URL:', { url: window.location.href });
            addResult('info', 'Target MCP URL:', { mcpUrl: mcpUrl });

            // Test 7: Network tab simulation
            addResult('info', 'Test 7: Check browser console and network tab for more details');
            addResult('info', 'Browser info:', {
                userAgent: navigator.userAgent,
                language: navigator.language,
                cookieEnabled: navigator.cookieEnabled
            });
        }

        // Run all tests
        debugMCPRequest();
    </script>
</body>
</html>