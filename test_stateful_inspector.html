<!DOCTYPE html>
<html>
<head>
    <title>Test Stateful MCP Inspector</title>
    <script>
        // Test the stateful MCP server directly
        window.onload = async function() {
            console.log('üß™ Testing stateful MCP inspector...');

            // Test with the stateful server on port 8011
            const transport = new (class MCPHttpTransport {
                constructor(url) {
                    this.url = url;
                    this.sessionId = null;
                }

                async send(request) {
                    const headers = {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json, text/event-stream',
                    };

                    if (this.sessionId) {
                        headers['mcp-session-id'] = this.sessionId;
                    }

                    const response = await fetch(this.url, {
                        method: 'POST',
                        headers: headers,
                        body: JSON.stringify(request)
                    });

                    // Capture session ID
                    const mcpSessionId = response.headers.get('mcp-session-id');
                    if (mcpSessionId) {
                        this.sessionId = mcpSessionId;
                        console.log('üîë Captured session ID:', mcpSessionId);
                    }

                    if (!response.ok) {
                        if (response.status === 400) {
                            const errorText = await response.text();
                            if (errorText.includes('Missing session ID')) {
                                console.log('üîë Server requires session initialization');
                                return { error: { code: -32600, message: 'Session required' } };
                            }
                        }
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }

                    const responseText = await response.text();

                    // Handle SSE format
                    if (responseText.startsWith('event: message')) {
                        const lines = responseText.split('\\n');
                        for (const line of lines) {
                            if (line.startsWith('data: ')) {
                                return JSON.parse(line.substring(6));
                            }
                        }
                    } else {
                        return JSON.parse(responseText);
                    }
                }
            })('http://localhost:8011/mcp');

            const client = new (class MCPClient {
                constructor(transport) {
                    this.transport = transport;
                    this.requestId = 0;
                    this.initialized = false;
                }

                async request(method, params = {}) {
                    const request = {
                        jsonrpc: '2.0',
                        id: ++this.requestId,
                        method: method,
                        params: params
                    };

                    const response = await this.transport.send(request);

                    if (response.error && response.error.message === 'Session required') {
                        console.log('üîÑ Initializing session...');
                        await this.initialize();
                        return await this.request(method, params);
                    }

                    if (response.error) {
                        throw new Error(response.error.message);
                    }

                    return response.result;
                }

                async initialize() {
                    if (this.initialized) return;

                    // Step 1: Initialize
                    const initRequest = {
                        jsonrpc: '2.0',
                        id: ++this.requestId,
                        method: 'initialize',
                        params: {
                            protocolVersion: '2024-11-05',
                            capabilities: {},
                            clientInfo: {
                                name: 'Test Client',
                                version: '1.0.0'
                            }
                        }
                    };

                    const response = await this.transport.send(initRequest);
                    if (response.error) {
                        throw new Error(`Init failed: ${response.error.message}`);
                    }

                    // Step 2: Send initialized notification
                    const notification = {
                        jsonrpc: '2.0',
                        method: 'notifications/initialized',
                        params: {}
                    };

                    try {
                        await this.transport.send(notification);
                        console.log('‚úÖ Session fully initialized');
                    } catch (e) {
                        console.warn('‚ö†Ô∏è Notification failed:', e.message);
                    }

                    this.initialized = true;
                }

                async listTools() {
                    return await this.request('tools/list');
                }
            })(transport);

            try {
                console.log('1Ô∏è‚É£ Testing tools/list (should trigger session init)...');
                const result = await client.listTools();
                console.log('‚úÖ SUCCESS! Got tools:', result.tools.map(t => t.name));

                console.log('2Ô∏è‚É£ Testing second call (should reuse session)...');
                const result2 = await client.listTools();
                console.log('‚úÖ SUCCESS! Second call worked, got', result2.tools.length, 'tools');

                document.body.innerHTML = `
                    <h1>‚úÖ Stateful MCP Client Test Success!</h1>
                    <p>Session ID: ${transport.sessionId}</p>
                    <p>Found ${result.tools.length} tools:</p>
                    <ul>
                        ${result.tools.map(t => `<li><strong>${t.name}</strong>: ${t.description}</li>`).join('')}
                    </ul>
                `;

            } catch (error) {
                console.error('‚ùå Test failed:', error);
                document.body.innerHTML = `<h1>‚ùå Test Failed</h1><p>${error.message}</p>`;
            }
        };
    </script>
</head>
<body>
    <h1>Testing Stateful MCP...</h1>
    <p>Check console for details</p>
</body>
</html>