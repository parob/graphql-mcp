<!DOCTYPE html>
<html>
<head>
    <title>Browser MCP Debug Tool</title>
    <style>
        body { font-family: monospace; padding: 20px; background: #f5f5f5; }
        .test { margin: 15px 0; padding: 15px; border-radius: 5px; background: white; border-left: 4px solid #ccc; }
        .success { border-left-color: #28a745; }
        .error { border-left-color: #dc3545; }
        .info { border-left-color: #17a2b8; }
        pre { background: #f8f9fa; padding: 10px; border-radius: 5px; overflow-x: auto; max-height: 300px; }
        button { padding: 10px 20px; margin: 5px; border: none; border-radius: 5px; cursor: pointer; }
        .btn-primary { background: #007bff; color: white; }
        .btn-danger { background: #dc3545; color: white; }
        input { padding: 8px; margin: 5px; border: 1px solid #ddd; border-radius: 3px; width: 300px; }
    </style>
</head>
<body>
    <h1>Browser MCP Debug Tool</h1>

    <div>
        <label>MCP Server URL:</label>
        <input type="text" id="mcpUrl" value="http://localhost:8010/mcp" />
        <button class="btn-primary" onclick="testAllEndpoints()">Test All</button>
        <button class="btn-danger" onclick="clearResults()">Clear</button>
    </div>

    <div id="results"></div>

    <script>
        async function log(type, title, data = null, error = null) {
            const div = document.createElement('div');
            div.className = `test ${type}`;

            let html = `<strong>${title}</strong><br>`;
            if (error) {
                html += `<span style="color: red;">Error: ${error}</span><br>`;
            }
            if (data) {
                html += `<pre>${JSON.stringify(data, null, 2)}</pre>`;
            }

            div.innerHTML = html;
            document.getElementById('results').appendChild(div);
        }

        async function clearResults() {
            document.getElementById('results').innerHTML = '';
        }

        async function testAllEndpoints() {
            clearResults();
            const url = document.getElementById('mcpUrl').value;

            log('info', 'Starting comprehensive MCP testing', { url: url, timestamp: new Date().toISOString() });

            // Test 1: Basic connectivity (GET)
            try {
                log('info', 'Test 1: GET request to MCP endpoint');
                const getResponse = await fetch(url, { method: 'GET' });
                log('info', `GET Response: ${getResponse.status} ${getResponse.statusText}`, {
                    headers: Object.fromEntries(getResponse.headers.entries()),
                    body: await getResponse.text()
                });
            } catch (error) {
                log('error', 'Test 1: GET request failed', null, error.message);
            }

            // Test 2: Tools/list with minimal headers
            try {
                log('info', 'Test 2: tools/list with minimal headers');
                const response = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        jsonrpc: '2.0',
                        id: 1,
                        method: 'tools/list',
                        params: {}
                    })
                });

                const text = await response.text();
                log(response.ok ? 'success' : 'error', `Test 2: ${response.status} ${response.statusText}`, {
                    status: response.status,
                    headers: Object.fromEntries(response.headers.entries()),
                    body: text.substring(0, 500) + (text.length > 500 ? '...' : ''),
                    fullBodyLength: text.length
                });
            } catch (error) {
                log('error', 'Test 2: tools/list (minimal) failed', null, error.message);
            }

            // Test 3: Tools/list with proper headers (same as inspector)
            try {
                log('info', 'Test 3: tools/list with proper headers (same as frontend)');
                const response = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json, text/event-stream'
                    },
                    body: JSON.stringify({
                        jsonrpc: '2.0',
                        id: 2,
                        method: 'tools/list',
                        params: {}
                    })
                });

                const text = await response.text();

                // Parse SSE format
                let parsed = null;
                if (text.startsWith('event: message')) {
                    const lines = text.split('\\n');
                    for (const line of lines) {
                        if (line.startsWith('data: ')) {
                            try {
                                parsed = JSON.parse(line.substring(6));
                                break;
                            } catch (e) {
                                // Continue looking
                            }
                        }
                    }
                }

                log(response.ok ? 'success' : 'error', `Test 3: ${response.status} ${response.statusText}`, {
                    status: response.status,
                    headers: Object.fromEntries(response.headers.entries()),
                    rawBody: text.substring(0, 300) + (text.length > 300 ? '...' : ''),
                    parsedData: parsed ? {
                        tools: parsed.result?.tools?.map(t => ({ name: t.name, description: t.description })) || 'No tools'
                    } : 'Failed to parse SSE',
                    fullBodyLength: text.length
                });
            } catch (error) {
                log('error', 'Test 3: tools/list (proper headers) failed', null, error.message);
            }

            // Test 4: Initialize
            try {
                log('info', 'Test 4: MCP initialize');
                const response = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json, text/event-stream'
                    },
                    body: JSON.stringify({
                        jsonrpc: '2.0',
                        id: 3,
                        method: 'initialize',
                        params: {
                            protocolVersion: '2024-11-05',
                            capabilities: {},
                            clientInfo: {
                                name: 'Browser Debug Client',
                                version: '1.0.0'
                            }
                        }
                    })
                });

                const text = await response.text();
                log(response.ok ? 'success' : 'error', `Test 4: Initialize ${response.status} ${response.statusText}`, {
                    status: response.status,
                    body: text.substring(0, 400) + (text.length > 400 ? '...' : ''),
                    fullBodyLength: text.length
                });
            } catch (error) {
                log('error', 'Test 4: Initialize failed', null, error.message);
            }

            // Test 5: Browser info
            log('info', 'Test 5: Browser and environment info', {
                userAgent: navigator.userAgent,
                language: navigator.language,
                cookieEnabled: navigator.cookieEnabled,
                onLine: navigator.onLine,
                currentUrl: window.location.href,
                timestamp: new Date().toISOString()
            });

            // Test 6: Network timing (if available)
            if (performance.getEntriesByType) {
                const networkEntries = performance.getEntriesByType('navigation');
                if (networkEntries.length > 0) {
                    log('info', 'Test 6: Performance timing', {
                        navigation: {
                            domContentLoaded: networkEntries[0].domContentLoadedEventEnd,
                            loadComplete: networkEntries[0].loadEventEnd,
                            type: networkEntries[0].type
                        }
                    });
                }
            }

            log('info', 'All tests completed');
        }

        // Auto-run tests when page loads
        window.onload = function() {
            // Give the page a moment to fully load
            setTimeout(testAllEndpoints, 500);
        };
    </script>
</body>
</html>